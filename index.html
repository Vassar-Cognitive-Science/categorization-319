<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Antenna Categorization Experiment</title>
  <script src="https://unpkg.com/jspsych@8.0.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jstat/latest/jstat.min.js"></script>

  <link href="https://unpkg.com/jspsych@8.0.2/css/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    /* Mobile-friendly styles */
    html, body {
      margin: 0;
      padding: 0;
      font-size: 18px;
      line-height: 1.4;
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    
    body {
      padding: 20px 10px;
    }
    
    /* Stimulus container adjustments */
    #jspsych-html-button-response-stimulus {
      max-width: 100%;
      margin-bottom: 30px;
    }
    
    /* Make content responsive */
    div[style*="width:800px"] {
      width: 100% !important;
      max-width: 100vw !important;
      box-sizing: border-box !important;
      padding: 0 10px !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    
    /* Ensure all content fits within viewport */
    .jspsych-display-element {
      width: 100% !important;
      max-width: 100vw !important;
      box-sizing: border-box !important;
      padding: 0 10px !important;
    }
    
    /* Fix text containers */
    p {
      max-width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      hyphens: auto !important;
    }
    
    /* Custom button styling for mobile */
    .jspsych-btn {
      display: block !important;
      width: 100% !important;
      max-width: 300px !important;
      height: 60px !important;
      margin: 15px auto !important;
      font-size: 20px !important;
      font-weight: bold !important;
      border-radius: 10px !important;
      border: 2px solid #007bff !important;
      background-color: #007bff !important;
      color: white !important;
      cursor: pointer !important;
      transition: background-color 0.2s !important;
    }
    
    .jspsych-btn:hover, .jspsych-btn:active {
      background-color: #0056b3 !important;
      border-color: #0056b3 !important;
    }
    
    /* Button container */
    #jspsych-html-button-response-btngroup {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      gap: 10px !important;
    }
    
    /* SVG stimulus sizing */
    svg {
      max-width: 100% !important;
      height: auto !important;
    }
    
    /* Prompt styling */
    .jspsych-html-button-response-prompt {
      font-size: 20px !important;
      font-weight: bold !important;
      margin-bottom: 20px !important;
      text-align: center !important;
    }
  </style>
</head>
<body></body>
<script>
  // Initialize jsPsych
  var jsPsych = initJsPsych();

  // heavily inspired by Markant & Gureckis (e.g., http://smash.psych.nyu.edu/courses/spring12/lhc/lectures/lecture10.pdf)

  function resolveToPoint(deg, r) {
      var rad = Math.PI * deg / 180;
      return {mX: r * Math.cos(rad), mY: r * Math.sin(rad)};
  }

  function create_stimulus(x,y){

    var s = Snap(400,400);
    s.circle(200, 200, 100 + x*50).attr({
      fill: '#fff',
      stroke: '#000',
      strokeWidth: 5
    });
    var pt = resolveToPoint(y*180, 100+x*50);
    s.line(200+pt.mX, 200+pt.mY, 200-pt.mX, 200-pt.mY).attr({
      stroke: '#000',
      strokeWidth: 5
    });

    var html = '<svg width="400" height="400" version="1.1" xmlns="http://www.w3.org/2000/svg">';
    html += s.innerSVG();
    html+= '</svg>'

    s.remove();

    return html;

  }

  var timeline = [];

  // instructions
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="width:800px; text-align: center;">'+
      '<img src="img/loop.PNG" style="max-width: 100%; height: auto; margin-bottom: 20px; display: block;"></img>'+
      '<div style="text-align: left;">'+
      '<p>In this neighborhood, there are only two TV channels: channel 1 and channel 2.'+
      ' Antennas, like the one in the picture, can pick up only one of the channels at a time. Different antenna designs will '+
      'pick up different channels.</p><p>In this experiment, you will learn which kind of antenna picks up which channel.</p>'+
      '</div></div>',
    choices: ['Continue']
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="width:800px; text-align: left;">'+
      '<p>You will get to see one antenna at a time and guess whether it picks up channel 1 or channel 2.</p>'+
      '<p>You will be told whether your guess was right or wrong each time. Try to learn what makes an antenna a channel 1 or channel 2 antenna.</p>'+
      '</div>',
    choices: ['Begin']
  });

  // trial generation
  function create_trial(category){
    var x = -1;
    var y = -1;
    var mx, my;
    if(category==1){
      mx = 0.25;
      my = 0.5;
    } else {
      mx = 0.75;
      my = 0.5;
    }
    while(x < 0 || x > 1 || y < 0 || y > 1){
      x = jStat.normal.sample(mx, 0.1);
      y = jStat.normal.sample(my, 0.1);
    }
    return {x, y, button: (category==1)? 0 : 1, label: 'channel '+category}
  }

  // categorization
  var categorization_trials = [];
  for(var i=0; i<15; i++){
    categorization_trials.push(create_trial(1), create_trial(2));
  }

  timeline.push({
    timeline_variables: categorization_trials,
    randomize_order: true,
    timeline: [
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: function(){
          const x = jsPsych.evaluateTimelineVariable('x');
          const y = jsPsych.evaluateTimelineVariable('y');
          return create_stimulus(x, y);
        },
        choices: ['Channel 1', 'Channel 2'],
        button_layout: 'flex',
        prompt: '<p>Does this antenna pick up channel 1 or 2?</p>',
        data: {
          correct_response: jsPsych.timelineVariable('button'),
          correct_label: jsPsych.timelineVariable('label'),
        },
        on_finish: function(data){
          data.correct = data.response == data.correct_response;
        }
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function(){
          var lastTrial = jsPsych.data.getLastTrialData().values()[0];
          var correct = lastTrial.correct;
          var label = lastTrial.correct_label;
          return correct ? 
            '<p>Correct! This antenna picks up ' + label + '.</p>' :
            '<p>Incorrect. This antenna picks up ' + label + '.</p>';
        },
        choices: [],
        trial_duration: 1000,
        response_ends_trial: false,
        post_trial_gap: 200
      }
    ]
  });

  // generalization instructions
  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: '<div style="width:800px; text-align: left;">'+
      '<p>Now you are going to be tested on how well you learned the categories. The procedure is the same, but you will no longer get any feedback.</p>'+
      '</div>',
    choices: ['Begin Test']
  });

  // generalization
  var generalization_trials = [];
  for(var i=0; i<10; i++){
    generalization_trials.push(create_trial(1), create_trial(2));
  }

  timeline.push({
    timeline_variables: generalization_trials,
    randomize_order: true,
    timeline: [
      {
        type: jsPsychHtmlButtonResponse,
        stimulus: function(){
          const x = jsPsych.evaluateTimelineVariable('x');
          const y = jsPsych.evaluateTimelineVariable('y');
          return create_stimulus(x, y);
        },
        choices: ['Channel 1', 'Channel 2'],
        button_layout: 'flex',
        data: {
          test: true,
          correct_response: jsPsych.timelineVariable('button')
        },
        prompt: '<p>Does this antenna pick up channel 1 or 2?</p>',
        post_trial_gap: 200,
        on_finish: function(data){
          data.correct = data.response == data.correct_response;
        }
      }
    ]
  });

  timeline.push({
    type: jsPsychHtmlButtonResponse,
    stimulus: function(){
      var pCorrect = 100 * jsPsych.data.get().filter({test: true, correct: true}).count() / 20;
      return '<div style="width:800px; text-align: left;">'+
      '<p>All done! You correctly categorized '+pCorrect+'% of the antennas.</p>'+
      '</div>'
    },
    choices: ['Finish']
  });

  jsPsych.run(timeline)
</script>
</html>
